<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel de Administraci√≥n - VapeDealer MX</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 50%, #2d2d2d 100%);
      color: white;
      line-height: 1.6;
      min-height: 100vh;
    }

    .admin-header {
      background: linear-gradient(135deg, #1e1e1e 0%, #2a2a2a 100%);
      padding: 25px 30px;
      border-bottom: 2px solid rgba(37, 211, 102, 0.2);
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(10px);
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
    }

    .admin-title {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .admin-logo {
      font-size: 1.8em;
      font-weight: 700;
      background: linear-gradient(45deg, #25D366 0%, #20b358 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .admin-subtitle {
      color: #b0b0b0;
      font-size: 0.9em;
      font-weight: 400;
    }

    .user-info {
      color: #888;
      font-size: 0.85em;
      margin-top: 5px;
    }

    .header-actions {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .btn-secondary {
      padding: 10px 20px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      color: white;
      text-decoration: none;
      font-size: 0.9em;
      font-weight: 500;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.15);
      transform: translateY(-2px);
    }

    .logout-btn {
      padding: 10px 20px;
      background: linear-gradient(45deg, #ff6b6b 0%, #ee5a52 100%);
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 0.9em;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .logout-btn:hover {
      transform: translateY(-2px);
      filter: brightness(1.1);
    }

    .admin-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px 30px;
      display: grid;
      gap: 40px;
    }

    .add-product-section {
      background: linear-gradient(135deg, rgba(30, 30, 30, 0.95), rgba(45, 45, 45, 0.9));
      border-radius: 20px;
      padding: 35px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .section-icon {
      font-size: 1.8em;
      color: #25D366;
    }

    .section-title {
      font-size: 1.5em;
      font-weight: 600;
      color: white;
    }

    .section-description {
      color: #b0b0b0;
      font-size: 0.95em;
      margin-top: 5px;
      font-weight: 300;
    }

    .product-form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 25px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group.full-width {
      grid-column: 1 / -1;
    }

    .form-label {
      color: #d0d0d0;
      font-size: 0.95em;
      font-weight: 500;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .form-input, .form-select {
      padding: 15px 18px;
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      background: rgba(0, 0, 0, 0.3);
      color: white;
      font-size: 1em;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-family: inherit;
    }

    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: #25D366;
      background: rgba(0, 0, 0, 0.5);
      box-shadow: 0 0 0 3px rgba(37, 211, 102, 0.1);
      transform: translateY(-2px);
    }

    .form-input::placeholder {
      color: #666;
      font-weight: 300;
    }

    .form-select option {
      background: #1a1a1a;
      color: white;
    }

    .image-input-group {
      position: relative;
    }

    .image-preview {
      margin-top: 15px;
      padding: 20px;
      border: 2px dashed rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      text-align: center;
      background: rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
    }

    .image-preview.has-image {
      border-color: #25D366;
      background: rgba(37, 211, 102, 0.05);
    }

    .preview-image {
      max-width: 200px;
      max-height: 150px;
      border-radius: 8px;
      margin-bottom: 10px;
    }

    .preview-placeholder {
      color: #888;
      font-size: 0.9em;
    }

    .btn-primary {
      grid-column: 1 / -1;
      padding: 16px 30px;
      background: linear-gradient(45deg, #25D366 0%, #20b358 100%);
      border: none;
      border-radius: 12px;
      color: white;
      font-size: 1.1em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 8px 25px rgba(37, 211, 102, 0.25);
      position: relative;
      overflow: hidden;
      margin-top: 20px;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 12px 35px rgba(37, 211, 102, 0.35);
      filter: brightness(1.1);
    }

    .btn-primary:active:not(:disabled) {
      transform: translateY(-1px);
    }

    .btn-primary:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }

    .products-section {
      background: linear-gradient(135deg, rgba(30, 30, 30, 0.95), rgba(45, 45, 45, 0.9));
      border-radius: 20px;
      padding: 35px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
    }

    .products-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
      gap: 20px;
    }

    .products-count {
      background: rgba(37, 211, 102, 0.2);
      color: #25D366;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.9em;
      font-weight: 500;
    }

    .search-box {
      padding: 12px 18px;
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 25px;
      background: rgba(0, 0, 0, 0.3);
      color: white;
      font-size: 0.9em;
      width: 250px;
      transition: all 0.3s ease;
    }

    .search-box:focus {
      outline: none;
      border-color: #25D366;
      width: 300px;
    }

    #lista-productos {
      display: grid;
      gap: 20px;
    }

    .product-item {
      background: linear-gradient(135deg, rgba(20, 20, 20, 0.8), rgba(35, 35, 35, 0.6));
      border-radius: 15px;
      padding: 25px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .product-item:hover {
      transform: translateY(-2px);
      border-color: rgba(37, 211, 102, 0.3);
      box-shadow: 0 10px 30px rgba(37, 211, 102, 0.1);
    }

    .product-content {
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 25px;
      align-items: start;
    }

    .product-image {
      width: 120px;
      height: 120px;
      border-radius: 12px;
      object-fit: cover;
      background: rgba(0, 0, 0, 0.3);
    }

    .product-details {
      min-width: 0;
    }

    .product-name {
      font-size: 1.3em;
      font-weight: 600;
      color: white;
      margin-bottom: 8px;
      line-height: 1.3;
    }

    .product-price {
      font-size: 1.2em;
      font-weight: 700;
      color: #25D366;
      margin-bottom: 12px;
    }

    .product-description {
      color: #b0b0b0;
      font-size: 0.95em;
      line-height: 1.5;
      margin-bottom: 15px;
    }

    .product-actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .btn-delete {
      padding: 10px 18px;
      background: linear-gradient(45deg, #ff6b6b 0%, #ee5a52 100%);
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 0.9em;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      justify-content: center;
    }

    .btn-delete:hover {
      transform: translateY(-2px);
      filter: brightness(1.1);
      box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
    }

    .loading-state {
      text-align: center;
      padding: 60px 20px;
      color: #888;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(37, 211, 102, 0.3);
      border-top: 3px solid #25D366;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #888;
    }

    .empty-icon {
      font-size: 3em;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    .notification {
      position: fixed;
      top: 30px;
      right: 30px;
      padding: 15px 25px;
      border-radius: 12px;
      color: white;
      font-weight: 500;
      z-index: 1000;
      transform: translateX(400px);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.success {
      background: rgba(37, 211, 102, 0.9);
      border: 1px solid rgba(37, 211, 102, 0.3);
    }

    .notification.error {
      background: rgba(255, 107, 107, 0.9);
      border: 1px solid rgba(255, 107, 107, 0.3);
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
      .admin-container {
        padding: 20px 15px;
      }

      .header-content {
        flex-direction: column;
        align-items: flex-start;
      }

      .product-form {
        grid-template-columns: 1fr;
      }

      .product-content {
        grid-template-columns: 1fr;
        gap: 20px;
      }

      .product-image {
        width: 100%;
        height: 200px;
        justify-self: center;
      }

      .product-actions {
        flex-direction: row;
        justify-content: center;
      }

      .search-box {
        width: 100%;
      }

      .search-box:focus {
        width: 100%;
      }

      .notification {
        right: 15px;
        left: 15px;
        transform: translateY(-100px);
      }

      .notification.show {
        transform: translateY(0);
      }
    }
  </style>
</head>
<body>
  <header class="admin-header">
    <div class="header-content">
      <div class="admin-title">
        <div>
          <div class="admin-logo">VapeDealer MX</div>
          <div class="admin-subtitle">Panel de Administraci√≥n</div>
          <div class="user-info" id="user-info">Cargando...</div>
        </div>
      </div>
      <div class="header-actions">
        <a href="index.html" class="btn-secondary">
          <span>üè™</span>
          <span>Ver tienda</span>
        </a>
        <button onclick="logout()" class="logout-btn">
          <span>üö™</span>
          <span>Salir</span>
        </button>
      </div>
    </div>
  </header>

  <div class="admin-container">
    <section class="add-product-section">
      <div class="section-header">
        <div class="section-icon">‚ûï</div>
        <div>
          <h2 class="section-title">Agregar nuevo producto</h2>
          <p class="section-description">Completa todos los campos para a√±adir un producto al cat√°logo</p>
        </div>
      </div>

      <div class="product-form">
        <div class="form-group">
          <label class="form-label">
            <span>üì¶</span>
            <span>Nombre del producto</span>
          </label>
          <input 
            type="text" 
            id="nombre" 
            class="form-input"
            placeholder="Ej: Vape Premium XL"
            required
          />
        </div>

        <div class="form-group">
          <label class="form-label">
            <span>üí∞</span>
            <span>Precio (MXN)</span>
          </label>
          <input 
            type="number" 
            id="precio" 
            class="form-input"
            placeholder="Ej: 599"
            step="0.01"
            min="0"
            required
          />
        </div>

        <div class="form-group">
          <label class="form-label">
            <span>üìä</span>
            <span>Stock inicial</span>
          </label>
          <input 
            type="number" 
            id="stock" 
            class="form-input"
            placeholder="Ej: 10"
            min="0"
            value="10"
            required
          />
        </div>

        <div class="form-group">
          <label class="form-label">
            <span>üìÅ</span>
            <span>Categor√≠a</span>
          </label>
          <select id="categoria" class="form-select">
            <option value="">Seleccionar categor√≠a...</option>
          </select>
        </div>

        <div class="form-group full-width">
          <label class="form-label">
            <span>üìù</span>
            <span>Descripci√≥n</span>
          </label>
          <input 
            type="text" 
            id="descripcion" 
            class="form-input"
            placeholder="Describe las caracter√≠sticas principales del producto..."
            required
          />
        </div>

        <div class="form-group full-width">
          <label class="form-label">
            <span>üñºÔ∏è</span>
            <span>URL de la imagen</span>
          </label>
          <div class="image-input-group">
            <input 
              type="url" 
              id="imagen" 
              class="form-input"
              placeholder="https://i.imgur.com/ejemplo.jpg"
              title="Sube la imagen a Imgur y pega aqu√≠ el enlace directo"
              required
            />
            <div class="image-preview" id="image-preview">
              <div class="preview-placeholder">
                üì∏ La vista previa de la imagen aparecer√° aqu√≠
              </div>
            </div>
          </div>
        </div>

        <button type="button" id="agregar" class="btn-primary">
          <span>‚ú® Agregar producto al cat√°logo</span>
        </button>
      </div>
    </section>

    <section class="products-section">
      <div class="section-header">
        <div class="section-icon">üìã</div>
        <div>
          <h2 class="section-title">Productos en el cat√°logo</h2>
          <p class="section-description">Gestiona todos los productos de tu tienda</p>
        </div>
      </div>

      <div class="products-header">
        <div class="products-count" id="products-count">
          0 productos
        </div>
        <input 
          type="text" 
          class="search-box" 
          placeholder="üîç Buscar productos..."
          id="search-products"
        />
      </div>

      <div id="lista-productos">
        <div class="loading-state">
          <div class="loading-spinner"></div>
          <p>Cargando productos...</p>
        </div>
      </div>
    </section>
  </div>

  <div id="notification" class="notification"></div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // Configuraci√≥n de Supabase
    const supabaseUrl = 'https://sjvgfhloimgzdheiqnuj.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNqdmdmaGxvaW1nemRoZWlxbnVqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwMDg0OTIsImV4cCI6MjA3NjU4NDQ5Mn0.ieXM9A9sw4a0uOnzvHQ887xyb8gY_G_OvAsGM8I2tIs';
    const supabase = createClient(supabaseUrl, supabaseKey);

    // Referencias a elementos del DOM
    const nombre = document.getElementById("nombre");
    const precio = document.getElementById("precio");
    const stock = document.getElementById("stock");
    const descripcion = document.getElementById("descripcion");
    const imagen = document.getElementById("imagen");
    const categoria = document.getElementById("categoria");
    const agregar = document.getElementById("agregar");
    const lista = document.getElementById("lista-productos");
    const productsCount = document.getElementById("products-count");
    const searchBox = document.getElementById("search-products");
    const imagePreview = document.getElementById("image-preview");
    const userInfo = document.getElementById("user-info");

    let allProducts = [];
    let currentUser = null;
    let categoriasCache = [];

    // ========== FUNCIONES DE NOTIFICACI√ìN ==========
    function showNotification(message, type = 'success') {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.className = `notification ${type}`;
      notification.classList.add('show');
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, 4000);
    }

    // ========== PREVIEW DE IMAGEN ==========
    imagen.addEventListener('input', () => {
      const url = imagen.value.trim();
      if (url) {
        imagePreview.innerHTML = `
          <img src="${url}" alt="Preview" class="preview-image" 
               onerror="this.parentElement.innerHTML='<div class=\\'preview-placeholder\\'>‚ùå No se pudo cargar la imagen. Verifica la URL</div>'"
               onload="this.parentElement.classList.add('has-image')"
          />
          <div style="color: #25D366; font-size: 0.9em;">‚úÖ Imagen cargada correctamente</div>
        `;
      } else {
        imagePreview.innerHTML = '<div class="preview-placeholder">üì∏ La vista previa de la imagen aparecer√° aqu√≠</div>';
        imagePreview.classList.remove('has-image');
      }
    });

    // ========== CARGAR CATEGOR√çAS ==========
    async function cargarCategorias() {
      try {
        const { data: categorias, error } = await supabase
          .from('categorias')
          .select('id_categoria, nombre')
          .order('nombre');

        if (error) {
          console.warn('‚ö†Ô∏è Error cargando categor√≠as:', error);
          // Si hay error de RLS, usar categor√≠as por defecto
          categoriasCache = [
            { id_categoria: '1', nombre: 'Premium' },
            { id_categoria: '2', nombre: 'Nuevos' },
            { id_categoria: '3', nombre: 'Ofertas' },
            { id_categoria: '4', nombre: 'Populares' }
          ];
        } else {
          categoriasCache = categorias || [];
        }

        // Actualizar dropdown de categor√≠as
        categoria.innerHTML = '<option value="">Seleccionar categor√≠a...</option>';
        categoriasCache.forEach(cat => {
          const option = document.createElement('option');
          option.value = cat.id_categoria;
          option.textContent = cat.nombre;
          categoria.appendChild(option);
        });

        console.log('‚úÖ Categor√≠as cargadas:', categoriasCache.length);

      } catch (error) {
        console.error('‚ùå Error cargando categor√≠as:', error);
        categoriasCache = [];
      }
    }

    // ========== OBTENER CATEGOR√çA POR DEFECTO ==========
    async function obtenerCategoriaPorDefecto() {
      try {
        // Si hay categor√≠as en cache, usar la primera
        if (categoriasCache.length > 0) {
          return categoriasCache[0].id_categoria;
        }

        // Intentar obtener categor√≠as de la base de datos
        const { data: categorias, error } = await supabase
          .from('categorias')
          .select('id_categoria')
          .limit(1);

        if (error) throw error;

        if (categorias && categorias.length > 0) {
          return categorias[0].id_categoria;
        }

        // Si no hay categor√≠as, usar un ID por defecto
        console.warn('‚ö†Ô∏è No se encontraron categor√≠as, usando ID por defecto');
        return '1';

      } catch (error) {
        console.error('‚ùå Error obteniendo categor√≠a por defecto:', error);
        // En caso de error, usar un ID por defecto
        return '1';
      }
    }

   // ========== FUNCI√ìN PARA CARGAR PRODUCTOS ==========
    async function cargarProductos() {
      lista.innerHTML = '<div class="loading-state"><div class="loading-spinner"></div><p>Cargando productos...</p></div>';

      try {
        // Primero intentar cargar productos con join
        let { data: productos, error } = await supabase
          .from('productos')
          .select('*, categorias!inner(nombre)')
          .order('id_producto', { ascending: false });

        // Si falla el join, intentar sin √©l
        if (error) {
          console.warn('‚ö†Ô∏è Error con join, intentando sin categor√≠as:', error);
          const response = await supabase
            .from('productos')
            .select('*')
            .order('id_producto', { ascending: false });
          
          productos = response.data;
          error = response.error;
        }

        if (error) throw error;

        console.log('‚úÖ Productos cargados:', productos?.length || 0);
        allProducts = productos || [];
        actualizarVistaProductos(allProducts);
        actualizarContador(allProducts.length);
      } catch (error) {
        console.error("‚ùå Error cargando productos:", error);
        console.error("Detalles:", error.details, error.hint, error.code);
        lista.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">‚ùå</div>
            <h3>Error al cargar productos</h3>
            <p>${error.message}</p>
            <p style="font-size: 0.9em; color: #888; margin-top: 10px;">
              ${error.hint || 'Verifica los permisos de la tabla productos'}
            </p>
          </div>
        `;
        showNotification("Error al cargar productos", "error");
      }
    }

    // ========== ESCAPAR HTML ==========
    function escapeHtml(text) {
      const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      };
      return String(text).replace(/[&<>"']/g, m => map[m]);
    }

    // ========== ACTUALIZAR VISTA DE PRODUCTOS ==========
    function actualizarVistaProductos(products) {
      if (!products || products.length === 0) {
        lista.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üì¶</div>
            <h3>No hay productos</h3>
            <p>Agrega tu primer producto usando el formulario de arriba</p>
          </div>
        `;
        return;
      }

      lista.innerHTML = products.map(producto => `
        <div class="product-item" data-id="${producto.id_producto}">
          <div class="product-content">
            <img 
              src="${producto.imagen_url || 'https://via.placeholder.com/120'}" 
              alt="${escapeHtml(producto.nombre)}" 
              class="product-image" 
              onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22120%22 height=%22120%22 viewBox=%220 0 120 120%22%3E%3Crect width=%22120%22 height=%22120%22 fill=%22%23333%22/%3E%3Ctext x=%2260%22 y=%2260%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22white%22 font-size=%2240%22%3Eüì¶%3C/text%3E%3C/svg%3E'" 
            />
            
            <div class="product-details">
              <h3 class="product-name">${escapeHtml(producto.nombre)}</h3>
              <div class="product-price">$${parseFloat(producto.precio).toFixed(2)} MXN</div>
              <div style="color: #888; font-size: 0.9em; margin-bottom: 8px;">
                üìä Stock: ${producto.stock || 0} unidades
                ${producto.categorias ? `<br>üìÅ ${producto.categorias.nombre}` : ''}
              </div>
              <p class="product-description">${escapeHtml(producto.descripcion)}</p>
            </div>
            
            <div class="product-actions">
              <button onclick="eliminarProducto('${producto.id_producto}')" class="btn-delete">
                <span>üóëÔ∏è</span>
                <span>Eliminar</span>
              </button>
            </div>
          </div>
        </div>
      `).join('');
    }

    // ========== ACTUALIZAR CONTADOR ==========
    function actualizarContador(count) {
      productsCount.textContent = `${count} producto${count !== 1 ? 's' : ''}`;
    }

    // ========== B√öSQUEDA DE PRODUCTOS ==========
    searchBox.addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase().trim();
      
      if (searchTerm === '') {
        actualizarVistaProductos(allProducts);
        actualizarContador(allProducts.length);
      } else {
        const filtered = allProducts.filter(product => 
          (product.nombre && product.nombre.toLowerCase().includes(searchTerm)) ||
          (product.descripcion && product.descripcion.toLowerCase().includes(searchTerm)) ||
          (product.precio && product.precio.toString().includes(searchTerm))
        );
        actualizarVistaProductos(filtered);
        actualizarContador(filtered.length);
      }
    });

    // ========== VALIDAR FORMULARIO ==========
    function validarFormulario() {
      if (!nombre.value.trim()) {
        showNotification("Por favor, ingresa el nombre del producto", "error");
        nombre.focus();
        return false;
      }

      if (!precio.value || parseFloat(precio.value) <= 0) {
        showNotification("Por favor, ingresa un precio v√°lido", "error");
        precio.focus();
        return false;
      }

      if (!stock.value || parseInt(stock.value) < 0) {
        showNotification("Por favor, ingresa un stock v√°lido", "error");
        stock.focus();
        return false;
      }

      if (!categoria.value) {
        showNotification("Por favor, selecciona una categor√≠a", "error");
        categoria.focus();
        return false;
      }

      if (!descripcion.value.trim()) {
        showNotification("Por favor, ingresa una descripci√≥n", "error");
        descripcion.focus();
        return false;
      }

      if (!imagen.value.trim()) {
        showNotification("Por favor, ingresa la URL de la imagen", "error");
        imagen.focus();
        return false;
      }

      try {
        new URL(imagen.value);
      } catch {
        showNotification("Por favor, ingresa una URL v√°lida para la imagen", "error");
        imagen.focus();
        return false;
      }

      return true;
    }

    // ========== AGREGAR PRODUCTO ==========
    agregar.addEventListener("click", async () => {
      if (!validarFormulario()) return;

      agregar.disabled = true;
      agregar.innerHTML = '<span>‚è≥ Agregando producto...</span>';

      try {
        const nuevoProducto = {
          nombre: nombre.value.trim(),
          precio: parseFloat(precio.value),
          descripcion: descripcion.value.trim(),
          imagen_url: imagen.value.trim(),
          stock: parseInt(stock.value),
          id_categoria: categoria.value
        };

        console.log('üì§ Enviando producto:', nuevoProducto);

        const { data, error } = await supabase
          .from('productos')
          .insert([nuevoProducto])
          .select();

        if (error) throw error;

        console.log('‚úÖ Producto agregado:', data);

        // Limpiar formulario
        nombre.value = "";
        precio.value = "";
        stock.value = "10";
        descripcion.value = "";
        imagen.value = "";
        categoria.value = "";

        // Limpiar preview
        imagePreview.innerHTML = '<div class="preview-placeholder">üì∏ La vista previa de la imagen aparecer√° aqu√≠</div>';
        imagePreview.classList.remove('has-image');

        // Recargar lista
        await cargarProductos();
        showNotification("‚úÖ Producto agregado con √©xito", "success");

        // Scroll suave a la secci√≥n de productos
        document.querySelector('.products-section').scrollIntoView({ 
          behavior: 'smooth', 
          block: 'start' 
        });

      } catch (error) {
        console.error("‚ùå Error agregando producto:", error);
        showNotification("‚ùå Error: " + (error.message || "Error desconocido"), "error");
      } finally {
        agregar.disabled = false;
        agregar.innerHTML = '<span>‚ú® Agregar producto al cat√°logo</span>';
      }
    });

    // ========== ELIMINAR PRODUCTO ==========
    window.eliminarProducto = async (id) => {
      if (!confirm("¬øEst√°s seguro de que quieres eliminar este producto?\n\nEsta acci√≥n no se puede deshacer.")) {
        return;
      }

      const productItem = document.querySelector(`[data-id="${id}"]`);
      if (productItem) {
        productItem.style.opacity = '0.5';
        productItem.style.pointerEvents = 'none';
      }

      try {
        console.log('üóëÔ∏è Eliminando producto ID:', id);

        const { error } = await supabase
          .from('productos')
          .delete()
          .eq('id_producto', id);

        if (error) throw error;

        console.log('‚úÖ Producto eliminado correctamente');
        await cargarProductos();
        showNotification("üóëÔ∏è Producto eliminado correctamente", "success");
      } catch (error) {
        console.error("‚ùå Error eliminando producto:", error);
        showNotification("‚ùå Error al eliminar: " + error.message, "error");
        
        if (productItem) {
          productItem.style.opacity = '1';
          productItem.style.pointerEvents = 'auto';
        }
      }
    };

    // ========== VERIFICAR AUTENTICACI√ìN ==========
    async function verificarAutenticacion() {
      try {
        const { data: { session }, error } = await supabase.auth.getSession();
        
        if (error) throw error;
        
        if (!session) {
          showNotification("‚ö†Ô∏è Sesi√≥n no encontrada. Redirigiendo al login...", "error");
          setTimeout(() => {
            window.location.href = 'login.html';
          }, 2000);
          return false;
        }

        currentUser = session.user;
        const userRole = session.user.user_metadata?.role;
        
        console.log('‚úÖ Usuario autenticado:', session.user.email);
        console.log('üìå Rol:', userRole);
        
        // Actualizar info de usuario en header
        userInfo.textContent = `üë§ ${session.user.email}`;
        
        if (userRole !== 'dashboard_user' && userRole !== 'admin') {
          showNotification("‚ö†Ô∏è No tienes permisos de administrador", "error");
          setTimeout(() => {
            window.location.href = 'login.html';
          }, 2000);
          return false;
        }
        
        return true;
      } catch (error) {
        console.error('‚ùå Error verificando autenticaci√≥n:', error);
        showNotification("Error de autenticaci√≥n", "error");
        setTimeout(() => {
          window.location.href = 'login.html';
        }, 2000);
        return false;
      }
    }

    // ========== FUNCI√ìN DE LOGOUT ==========
    window.logout = async function() {
      if (confirm('¬øSeguro que quieres cerrar sesi√≥n?')) {
        try {
          showNotification("üëã Cerrando sesi√≥n...", "success");
          
          // Cerrar sesi√≥n en Supabase
          const { error } = await supabase.auth.signOut();
          if (error) throw error;
          
          // Limpiar almacenamiento local
          sessionStorage.clear();
          localStorage.clear();
          
          console.log('‚úÖ Sesi√≥n cerrada correctamente');
          
          setTimeout(() => {
            window.location.href = 'login.html';
          }, 1000);
        } catch (error) {
          console.error('‚ùå Error al cerrar sesi√≥n:', error);
          showNotification("Error al cerrar sesi√≥n", "error");
        }
      }
    };

    // ========== VERIFICAR CONEXI√ìN A SUPABASE ==========
    async function verificarConexion() {
      try {
        const { error } = await supabase
          .from('productos')
          .select('count')
          .limit(1);
        
        if (error) throw error;
        console.log('‚úÖ Conexi√≥n a Supabase establecida correctamente');
        return true;
      } catch (error) {
        console.error('‚ùå Error de conexi√≥n a Supabase:', error);
        showNotification("‚ö†Ô∏è Problema de conexi√≥n con la base de datos", "error");
        return false;
      }
    }

    // ========== INICIALIZACI√ìN ==========
    async function inicializar() {
      console.log('üöÄ Inicializando panel de administraci√≥n...');
      
      // Verificar autenticaci√≥n primero
      const estaAutenticado = await verificarAutenticacion();
      if (!estaAutenticado) {
        return;
      }
      
      // Verificar conexi√≥n
      const conexionOk = await verificarConexion();
      
      if (conexionOk) {
        // Cargar categor√≠as primero
        await cargarCategorias();
        
        // Cargar productos
        await cargarProductos();
        
        console.log('‚úÖ Panel de administraci√≥n listo');
        showNotification("‚úÖ Bienvenido al panel de administraci√≥n", "success");
      } else {
        lista.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">‚ö†Ô∏è</div>
            <h3>Error de conexi√≥n</h3>
            <p>No se pudo conectar con la base de datos.</p>
            <button onclick="location.reload()" class="btn-primary" style="margin: 20px auto 0; max-width: 200px; display: block;">
              üîÑ Reintentar
            </button>
          </div>
        `;
      }
    }

    // ========== EJECUTAR AL CARGAR LA P√ÅGINA ==========
    window.addEventListener('DOMContentLoaded', async () => {
      await inicializar();
    });

    // Exponer para debugging
    window.supabase = supabase;
    console.log('üîß Supabase client disponible en window.supabase');

  </script>
</body>
</html>